<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/docker/CHANGES-SUMMARY.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/docker/CHANGES-SUMMARY.md" />
              <option name="updatedContent" value="#  Resumo das Correções - Docker Setup&#10;&#10;## ✅ Problemas Corrigidos&#10;&#10;### 1. **Dockerfile-service-auth**&#10;#### Antes:&#10;- ❌ Java 17 (incompatível com pom.xml que usa Java 21)&#10;- ❌ Porta 8080 (aplicação usa 8081)&#10;- ❌ Contexto de build incorreto&#10;- ❌ Sem otimizações de JVM&#10;&#10;#### Depois:&#10;- ✅ Java 21 (compatível)&#10;- ✅ Porta 8081 (correta)&#10;- ✅ Contexto corrigido (`app-service-auth/`)&#10;- ✅ Configurações de JVM adicionadas&#10;- ✅ Multi-stage build otimizado&#10;&#10;---&#10;&#10;### 2. **docker-compose.yml**&#10;#### Antes:&#10;- ❌ Variáveis de ambiente inconsistentes&#10;- ❌ URL do banco hardcoded&#10;- ❌ Faltava variável JWT_SECRET&#10;- ❌ Faltava variável SERVER_PORT&#10;- ❌ Path do Dockerfile incorreto&#10;&#10;#### Depois:&#10;- ✅ Variáveis padronizadas usando MARIADB_USER/PASSWORD&#10;- ✅ URL dinâmica usando ${MARIADB_DATABASE}&#10;- ✅ JWT_SECRET configurado&#10;- ✅ SERVER_PORT definido (8081)&#10;- ✅ Path correto: `docker/Dockerfile-service-auth`&#10;- ✅ Dialeto MariaDB explícito&#10;&#10;---&#10;&#10;### 3. **pom.xml**&#10;#### Antes:&#10;- ❌ **CRÍTICO**: Faltava driver MariaDB&#10;- ⚠️ Só tinha H2 (banco em memória)&#10;&#10;#### Depois:&#10;- ✅ Driver MariaDB adicionado (`mariadb-java-client`)&#10;- ✅ Mantido H2 para testes locais&#10;&#10;---&#10;&#10;### 4. **.env**&#10;#### Antes:&#10;- ⚠️ Variáveis duplicadas&#10;- ⚠️ Inconsistência nos nomes&#10;&#10;#### Depois:&#10;- ✅ Limpo e organizado&#10;- ✅ Apenas variáveis essenciais&#10;- ✅ Comentários explicativos&#10;&#10;---&#10;&#10;### 5. **Arquivos Novos Criados**&#10;&#10;#### ✨ `.dockerignore`&#10;- Otimiza o build Docker&#10;- Ignora arquivos desnecessários (target, node_modules, etc)&#10;&#10;#### ✨ `DEPLOY-INSTRUCTIONS.md`&#10;- Instruções completas de uso&#10;- Troubleshooting&#10;- Comandos úteis&#10;&#10;#### ✨ `start-docker.bat`&#10;- Script automatizado para Windows&#10;- Validações automáticas&#10;- Inicialização simplificada&#10;&#10;#### ✨ `init.sql`&#10;- Criação automática do banco&#10;- Tabela `usuarios` com estrutura completa&#10;- Exemplos de dados comentados&#10;&#10;---&#10;&#10;##  Estrutura Final&#10;&#10;```&#10;techchallenge3/&#10;├── .dockerignore                    ⭐ NOVO&#10;├── docker/&#10;│   ├── .env                         ✏️ ATUALIZADO&#10;│   ├── docker-compose.yml           ✏️ ATUALIZADO&#10;│   ├── Dockerfile-service-auth      ✏️ ATUALIZADO&#10;│   ├── DEPLOY-INSTRUCTIONS.md       ⭐ NOVO&#10;│   ├── start-docker.bat             ⭐ NOVO&#10;│   └── mariadb/&#10;│       ├── conf/&#10;│       │   └── my.cnf&#10;│       └── init/&#10;│           └── init.sql             ⭐ NOVO&#10;└── app-service-auth/&#10;    ├── pom.xml                      ✏️ ATUALIZADO&#10;    └── src/...&#10;```&#10;&#10;---&#10;&#10;##  Como Usar&#10;&#10;### Opção 1: Script Automatizado (Recomendado)&#10;```bash&#10;cd docker&#10;start-docker.bat&#10;```&#10;&#10;### Opção 2: Manual&#10;```bash&#10;cd docker&#10;docker-compose up --build&#10;```&#10;&#10;---&#10;&#10;##  Verificações Finais&#10;&#10;- [x] Java 21 em todo o stack&#10;- [x] Portas corretas (8081 app, 3366 db)&#10;- [x] Driver MariaDB instalado&#10;- [x] Variáveis de ambiente consistentes&#10;- [x] Init SQL funcionando&#10;- [x] Healthcheck do banco configurado&#10;- [x] Network dedicada&#10;- [x] Volumes persistentes&#10;- [x] Build otimizado&#10;- [x] Documentação completa&#10;&#10;---&#10;&#10;##  URLs&#10;&#10;- **API**: http://localhost:8081&#10;- **Database**: localhost:3366&#10;  - User: admin&#10;  - Password: noTnZQMVikRVQ6XKSJHgVaRO&#10;  - Database: techchallenge&#10;&#10;---&#10;&#10;##  Próximos Passos&#10;&#10;1. Teste a criação de usuários via endpoint&#10;2. Verifique se o JWT está sendo gerado corretamente&#10;3. Valide a persistência dos dados (restart containers)&#10;4. Configure CI/CD se necessário&#10;&#10;---&#10;&#10;**Tudo pronto para produção! **&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/docker/DEPLOY-INSTRUCTIONS.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/docker/DEPLOY-INSTRUCTIONS.md" />
              <option name="updatedContent" value="#  Instruções de Deploy - Tech Challenge 3&#10;&#10;## Pré-requisitos&#10;- Docker&#10;- Docker Compose&#10;&#10;##  Como subir a aplicação&#10;&#10;### 1. Entre no diretório docker&#10;```bash&#10;cd docker&#10;```&#10;&#10;### 2. Suba os containers&#10;```bash&#10;docker-compose up --build&#10;```&#10;&#10;Ou em modo detached (background):&#10;```bash&#10;docker-compose up -d --build&#10;```&#10;&#10;### 3. Verifique se os serviços estão rodando&#10;```bash&#10;docker-compose ps&#10;```&#10;&#10;##  Endpoints disponíveis&#10;&#10;- **API Auth Service**: http://localhost:8081&#10;- **MariaDB**: localhost:3366&#10;&#10;##  Acessar logs&#10;&#10;Ver logs de todos os serviços:&#10;```bash&#10;docker-compose logs -f&#10;```&#10;&#10;Ver logs apenas do app:&#10;```bash&#10;docker-compose logs -f app&#10;```&#10;&#10;Ver logs apenas do banco:&#10;```bash&#10;docker-compose logs -f db&#10;```&#10;&#10;##  Parar os containers&#10;&#10;```bash&#10;docker-compose down&#10;```&#10;&#10;Para remover também os volumes (apaga o banco de dados):&#10;```bash&#10;docker-compose down -v&#10;```&#10;&#10;##  Rebuild apenas do app&#10;&#10;Se você fez mudanças apenas no código da aplicação:&#10;```bash&#10;docker-compose up --build app&#10;```&#10;&#10;## ✅ O que foi configurado&#10;&#10;### Dockerfile (Dockerfile-service-auth)&#10;- ✅ Java 21 (compatível com o pom.xml)&#10;- ✅ Multi-stage build (otimizado)&#10;- ✅ Porta 8081 exposta&#10;- ✅ Contexto correto (raiz do projeto)&#10;- ✅ Configurações de JVM&#10;&#10;### Docker Compose (docker-compose.yml)&#10;- ✅ MariaDB 10.6 com healthcheck&#10;- ✅ Variáveis de ambiente do banco&#10;- ✅ Inicialização automática do banco (init.sql)&#10;- ✅ Dependência entre serviços (app espera DB estar saudável)&#10;- ✅ Network dedicada&#10;- ✅ Volume persistente para dados do banco&#10;&#10;### Banco de Dados (init.sql)&#10;- ✅ Criação do database `techchallenge`&#10;- ✅ Tabela `usuarios` com todos os campos&#10;- ✅ Índices para otimização&#10;- ✅ Suporte a todos os tipos de usuário (ADMIN, MEDICO, ENFERMEIRO, PACIENTE)&#10;&#10;### POM.xml&#10;- ✅ Driver MariaDB adicionado&#10;- ✅ Todas as dependências necessárias&#10;&#10;### Variáveis de Ambiente (.env)&#10;- ✅ Credenciais do MariaDB&#10;- ✅ JWT Secret&#10;- ✅ Sem duplicatas&#10;&#10;##  Troubleshooting&#10;&#10;### Erro de conexão com o banco&#10;Aguarde o banco inicializar completamente (pode levar 30-60 segundos na primeira vez).&#10;&#10;### Porta já em uso&#10;Verifique se não há outro serviço rodando nas portas 8081 ou 3366.&#10;&#10;### Rebuild completo&#10;```bash&#10;docker-compose down -v&#10;docker-compose build --no-cache&#10;docker-compose up&#10;```&#10;&#10;##  Notas importantes&#10;&#10;- O banco de dados é criado automaticamente na primeira execução&#10;- Os dados são persistidos no volume `mariadb_data`&#10;- O application.properties local aponta para localhost:3366 (desenvolvimento local)&#10;- O Docker Compose usa a porta interna 3306 do container&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/docker/JWT-CONFIG-EXPLANATION.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/docker/JWT-CONFIG-EXPLANATION.md" />
              <option name="updatedContent" value="#  Configuração JWT Secret - Explicação Completa&#10;&#10;## ✅ Problema Resolvido!&#10;&#10;A inconsistência no nome das variáveis JWT foi **corrigida**.&#10;&#10;---&#10;&#10;##  Estado Atual (CORRETO)&#10;&#10;### 1. **application.properties**&#10;```properties&#10;jwt.security.secret=${JWT_SECURITY_SECRET:404E635266556A586E3272357538782F413F4428472B4B6250645367566B5970}&#10;```&#10;- ✅ Usa variável de ambiente `JWT_SECURITY_SECRET`&#10;- ✅ Fallback para valor padrão se a variável não existir&#10;&#10;### 2. **docker-compose.yml**&#10;```yaml&#10;JWT_SECURITY_SECRET: ${JWT_SECRET:-404E635266556A586E3272357538782F413F4428472B4B6250645367566B5970}&#10;```&#10;- ✅ Lê de `.env` como `JWT_SECRET`&#10;- ✅ Passa para o container como `JWT_SECURITY_SECRET`&#10;- ✅ Fallback para o mesmo valor padrão&#10;&#10;### 3. **.env**&#10;```env&#10;JWT_SECRET=404E635266556A586E3272357538782F413F4428472B4B6250645367566B5970&#10;```&#10;- ✅ Valor único e centralizado&#10;&#10;### 4. **TokenService.java**&#10;```java&#10;@Value(&quot;${jwt.security.secret}&quot;)&#10;private String secret;&#10;```&#10;- ✅ Lê de `jwt.security.secret` (notação Spring Boot com pontos)&#10;- ✅ Spring converte automaticamente `JWT_SECURITY_SECRET` → `jwt.security.secret`&#10;&#10;---&#10;&#10;##  Como Funciona o Mapeamento&#10;&#10;### Spring Boot faz a conversão automática:&#10;&#10;```&#10;Variável de Ambiente          →  Propriedade Spring Boot&#10;━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━&#10;JWT_SECURITY_SECRET           →  jwt.security.secret&#10;SPRING_DATASOURCE_URL         →  spring.datasource.url&#10;SPRING_DATASOURCE_USERNAME    →  spring.datasource.username&#10;SERVER_PORT                   →  server.port&#10;```&#10;&#10;**Regras de conversão:**&#10;1. Maiúsculas → minúsculas&#10;2. Underscores `_` → pontos `.`&#10;3. Hífen `-` preservado&#10;&#10;---&#10;&#10;##  Fluxo Completo&#10;&#10;### Desenvolvimento Local (sem Docker):&#10;```&#10;application.properties&#10;├─ jwt.security.secret=${JWT_SECURITY_SECRET:valor_padrao}&#10;└─ Como JWT_SECURITY_SECRET não existe → usa valor_padrao&#10;```&#10;&#10;### Produção (com Docker):&#10;```&#10;.env&#10;├─ JWT_SECRET=valor_secreto&#10;    ↓&#10;docker-compose.yml&#10;├─ JWT_SECURITY_SECRET: ${JWT_SECRET}&#10;    ↓&#10;Container (variável de ambiente)&#10;├─ JWT_SECURITY_SECRET=valor_secreto&#10;    ↓&#10;Spring Boot (conversão automática)&#10;├─ jwt.security.secret=valor_secreto&#10;    ↓&#10;TokenService.java&#10;└─ @Value(&quot;${jwt.security.secret}&quot;) ✅&#10;```&#10;&#10;---&#10;&#10;## ✅ Valores em Todos os Lugares&#10;&#10;| Localização | Nome da Variável | Valor |&#10;|-------------|------------------|-------|&#10;| `.env` | `JWT_SECRET` | `404E635...` |&#10;| `docker-compose.yml` | `JWT_SECURITY_SECRET` | `${JWT_SECRET:-404E635...}` |&#10;| `application.properties` | `jwt.security.secret` | `${JWT_SECURITY_SECRET:404E635...}` |&#10;| `TokenService.java` | `${jwt.security.secret}` | (injetado) |&#10;&#10;**Todos apontam para o MESMO valor final! ✅**&#10;&#10;---&#10;&#10;##  Como Testar&#10;&#10;### 1. Desenvolvimento Local (IntelliJ/Eclipse)&#10;```bash&#10;# Rodar sem definir variável de ambiente&#10;# Deve usar o valor padrão&#10;mvn spring-boot:run&#10;```&#10;&#10;### 2. Com Docker&#10;```bash&#10;cd docker&#10;docker-compose up --build&#10;```&#10;&#10;### 3. Verificar no Log&#10;Procure por erros como:&#10;- ❌ `Could not resolve placeholder 'jwt.security.secret'`&#10;- ✅ Se não aparecer, está funcionando!&#10;&#10;---&#10;&#10;##  Segurança&#10;&#10;### ⚠️ IMPORTANTE:&#10;&#10;1. **Nunca commite o `.env`** no Git&#10;   ```bash&#10;   echo &quot;.env&quot; &gt;&gt; .gitignore&#10;   ```&#10;&#10;2. **Use secrets diferentes por ambiente:**&#10;   - Desenvolvimento: valor simples (já configurado)&#10;   - Produção: valor forte e único&#10;   - Homologação: valor diferente dos outros&#10;&#10;3. **Gere um novo secret para produção:**&#10;   ```bash&#10;   # Use um gerador online ou:&#10;   openssl rand -base64 32 | tr -d &quot;=+/&quot; | cut -c1-64&#10;   ```&#10;&#10;---&#10;&#10;##  Checklist Final&#10;&#10;- [x] JWT secret igual em todos os arquivos&#10;- [x] Conversão de nomes correta (Spring Boot)&#10;- [x] Fallback configurado para dev local&#10;- [x] Variável de ambiente no Docker Compose&#10;- [x] TokenService.java recebe o valor correto&#10;- [x] Documentação completa&#10;&#10;---&#10;&#10;**Tudo configurado e sincronizado! **&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>